@using MoonCore.Blazor.FlyonUi.Exceptions
@using MoonCore.Exceptions

@inject GlobalErrorService ErrorService

@if (IsLoading)
{
    <div class="@(EnableDefaultSpacing ? "mt-5" : "")">
        <div class="text-center">
            <div class="mb-3 flex justify-center">
                <Spinner Size="size-12" />
            </div>
            <p class="font-normal text-lg text-base-content">@(LoadingText)</p>
        </div>
    </div>
}
else
{
    if (LoadingException != null)
    {
        <div class="@(EnableDefaultSpacing ? "mt-5" : "")">
            <ErrorStateDisplay Exception="LoadingException"/>
        </div>
    }
    else
    {
        @ChildContent
    }
}

@code
{
    [Parameter] public RenderFragment ChildContent { get; set; }
    [Parameter] public Func<LazyLoader, Task> Load { get; set; }
    [Parameter] public bool EnableDefaultSpacing { get; set; } = true;

    private bool IsLoading = true;
    private Exception? LoadingException;

    private string LoadingText = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await DoLoadAsync();
    }

    private async Task DoLoadAsync()
    {
        try
        {
            await Load.Invoke(this);
        }
        catch (HttpApiException apiException)
        {
            // Redirect unauthenticated status errors directly to the global handler
            if (apiException.Status == 401)
                await ErrorService.HandleExceptionAsync(apiException);

            LoadingException = apiException;
        }
        catch (DisplayException displayException)
        {
            LoadingException = displayException;
        }

        IsLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    public async Task UpdateTextAsync(string text)
    {
        LoadingText = text;
        await InvokeAsync(StateHasChanged);
    }

    public async Task ReloadAsync()
    {
        LoadingException = null;
        IsLoading = true;
        await InvokeAsync(StateHasChanged);

        await DoLoadAsync();
    }
}